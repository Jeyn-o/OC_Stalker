<html>
<head>
<title> BC OC Viewer </title>
<script>
let oc_data;
let activity_data;
async function fetchGitHubData(url) {
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  return await response.json();
}

document.addEventListener('DOMContentLoaded', async function () {
  const url1 = 'https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/main/BC_OC.JSON';
  const url2 = 'https://raw.githubusercontent.com/Jeyn-o/OC_Stalker/main/BC_cron.JSON';

  try {
    const ocResponse = await fetchGitHubData(url1);
    oc_data = ocResponse;
    console.log("Stored as oc_data:");
    console.log(oc_data);

    const activityResponse = await fetchGitHubData(url2);
    activity_data = activityResponse;
    console.log("Stored as activity_data:");
    console.log(activity_data);

    populatePage(); // Now it's safe to call this
  } catch (error) {
    console.error("Error fetching data:", error);
  }
});

function toggle(num) {
document.querySelector('#recruiting').style.display="none";
document.querySelector('#planning').style.display="none";
document.querySelector('#completed').style.display="none";
document.querySelectorAll('.oc-display')[num].style.display="";
}
const crimes_slots = {
	"Pet Project": 				3, //done
	"Mob Mentality": 			4, //done
	"Best of the Lot": 			4, //done
	"Cash Me if You Can": 		3,
	"Smoke and Wing Mirrors": 	4, //done
	"Market Forces": 			5,
	"Gaslight the Way": 		6, //done
	"Stage Fright": 			6, //done
	"Snow Blind": 				4, //done
	"Counter Offer": 			5, //done
	"No Reserve": 				3, //done
	"Leave No Trace": 			3, //done
	"Bidding War": 				6, //done
	"Honey Trap": 				3, //done
	"Blast from the Past": 		6, //done
	"Stacking the Deck": 		4,
	"Break the Bank": 			6, //done
	"Ace in the Hole": 			5
};
const crimes_tiers = {
	"Pet Project": 				1, 
	"Mob Mentality": 			1, 
	"Best of the Lot": 			2,
	"Cash Me if You Can": 		2,
	"Smoke and Wing Mirrors": 	3,
	"Market Forces": 			3,
	"Gaslight the Way": 		3,
	"Stage Fright": 			4,
	"Snow Blind": 				4,
	"Counter Offer": 			5,
	"No Reserve": 				5,
	"Leave No Trace": 			5,
	"Bidding War": 				6,
	"Honey Trap": 				6,
	"Blast from the Past": 		7,
	"Stacking the Deck": 		8,
	"Break the Bank": 			8,
	"Ace in the Hole": 			9
};
async function populatePage() {
  for (const [id, item] of Object.entries(oc_data)) {
    let target;
    if (item.status === "Recruiting") {
      target = document.querySelector('#recruiting');
    } else if (item.status === "Planning") {
      target = document.querySelector('#planning');
    } else {
      target = document.querySelector('#completed');
    }

    let timer_msg;
    if (item.status === "Recruiting") {
      timer_msg = "Recruiting";
    } else if(item.status === "Planning") {
      // Add countdown placeholder span here
      timer_msg = `Ready: ${TCT(item.ready_at)} - in <span class="countdown"></span>`;
    } else {
      if (Math.abs(item.ready_at - item.executed_at) <= 60) {
		timer_msg = `Executed: ${TCT(item.executed_at)}`;
	} else {
		timer_msg = `Delayed: Ready since ${TCT(item.ready_at)} but executed at ${TCT(item.executed_at)}, delayed for ${formatDuration(item.ready_at, item.executed_at)}`;
	}
	if (item.status==="Successful") {timer_msg += ` - <b><span style="color:lime">Success</span></b>`};
	if (item.status==="Failure") {timer_msg += ` - <b><span style="color:#ff5500">Failure</span></b>`};

    }

    let slot_msg = ``;
	let slots_written = 0;
    for (const slot of Object.values(item.slots)) {
	  slots_written++;
      slot_msg += `
        <div class="oc-entry-content-slot">
          <span class="cpr">${slot.checkpoint_pass_rate}</span><br>
          <a href="https://www.torn.com/profiles.php?XID=${slot.user_id}">${slot.user_name}</a>
        </div>
		`;
    }
	if(item.status === "Recruiting") {
		//populate empty slots
		if(slots_written<crimes_slots[item.name]) {
			for(i=0;i<(crimes_slots[item.name]-slots_written);i++) {
				slot_msg += `
					<div class="oc-entry-content-slot"><br>Empty</div>
				`;
			}
		}
	}

    const entry = document.createElement('div');
    entry.className = "oc-entry";
	entry.id = id;
    entry.innerHTML = `
      <div class="oc-entry-header">[T${crimes_tiers[item.name]}] ${item.name} <a href=""><i>Link</i></a></div>
      <div class="oc-entry-timer">${timer_msg}</div>
      <div class="oc-entry-content">${slot_msg}</div>
    `;

    target.appendChild(entry);

    // Color code the checkpoint pass rate
    document.querySelectorAll('.cpr').forEach(item => {
      if (Number(item.innerHTML) < 50) {
        item.style.color = "orange";
      } else if (Number(item.innerHTML) < 85) {
        item.style.color = "yellow";
      } else {
        item.style.color = "lime";
      }
    });

    // START COUNTDOWN ONLY IF "Planning" (i.e., if countdown span exists inside this entry)
    const countdownEl = entry.querySelector('.countdown');
    if (countdownEl) {
      startCountdown(countdownEl, item.ready_at);
    }
  }
}


function TCT(unixEpoch) {
   const date = new Date(unixEpoch * 1000);
   const options = {
     timeZone: 'Europe/London',
     day: '2-digit',
     month: '2-digit',
     hour: '2-digit',
     minute: '2-digit',
     hour12: false
   };
   const formatter = new Intl.DateTimeFormat('en-GB', options);
   const parts = formatter.formatToParts(date);
   const day = parts.find(p => p.type === 'day').value;
   const month = parts.find(p => p.type === 'month').value;
   const hour = parts.find(p => p.type === 'hour').value;
   const minute = parts.find(p => p.type === 'minute').value;
   return `${day}.${month} - ${hour}:${minute}`;
}

function formatDuration(startEpoch, endEpoch) {
  const seconds = endEpoch - startEpoch;
  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;

  let result = '';
  if (days > 0) result += `${days}d `;
  if (hours > 0 || days > 0) result += `${hours}h `;
  if (minutes > 0 || hours > 0 || days > 0) result += `${minutes}m `;
  result += `${secs}s`;

  return result.trim();
}
function startCountdown(element, targetEpoch) {
  function update() {
    const now = Math.floor(Date.now() / 1000);
    let diff = targetEpoch - now;

    if (diff <= 0) {
      element.textContent = "Now";
      clearInterval(intervalId);
      return;
    }

    const days = Math.floor(diff / 86400);
    diff %= 86400;
    const hours = Math.floor(diff / 3600);
    diff %= 3600;
    const minutes = Math.floor(diff / 60);
    const seconds = diff % 60;

    element.textContent = 
      (days > 0 ? days + "d " : "") + 
      String(hours).padStart(2, "0") + ":" + 
      String(minutes).padStart(2, "0") + ":" + 
      String(seconds).padStart(2, "0");
  }

  update(); // initial call immediately
  const intervalId = setInterval(update, 1000);
  return intervalId;
}
</script>
<style>
body {
	background-color:#182028;
	color: #FFFFFF;
    text-shadow: 0 0 2px #000000;
	font-family:arial;
}

.oc-entry {
	background-color:#444;
	border-radius:1%;
	width:95%;
	height:400px;
	padding:1% 1%;
	margin: 2% 1%;
}

.oc-entry-header {
	font-weight:bold;
}

.oc-entry-content {
	display:flex;
	height:120px;
	width:100%;
}

.oc-entry-content-slot {
	background-color:#666;
	border:1px solid black;
	height:40px;
	width:100%;
	margin-left:1%;
	text-align:center;
}

a {
    color: #069;
    color: #74c0fc;
    cursor: pointer;
    text-decoration: none;
    transition: color .2s ease;
}

a:hover {
    color: #a1d5ff;
    cursor: pointer;
    text-decoration: none;
    transition: color .2s ease;
}

.cpr {
	margin-left: 90%;
}

#buttons {
	width:100%;
}

#buttons button {
	width:31%;
	height:40px;
	margin: 0 1%;
	font-size:24px;
	background-color:#444;
	color:#FFFFFF
}
</style>
</head>
<body>
<span id="notes">Note: OCs delays have a grace period of 60 seconds. This is for technical reasons.<br>
</span>
<div id="buttons">
<button onclick="toggle(0)">Recruiting</button>
<button onclick="toggle(1)">Planning</button>
<button onclick="toggle(2)">Completed</button>
</div>
<div class="oc-display" id="recruiting"></div>
<div class="oc-display" id="planning"></div>
<div class="oc-display" id="completed"></div>


</body>
</html>
